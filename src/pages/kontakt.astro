---
import BaseLayout from "../layouts/BaseLayout.astro";

const web3formsAccessKey = import.meta.env.PUBLIC_WEB3FORMS_ACCESS_KEY ?? "";
const isConfigured = web3formsAccessKey.trim().length > 0;
const requestType = Astro.url.searchParams.get("anliegen") ?? "";
const isPluginIdeas = requestType === "plugin-ideen";
const formSubject = isPluginIdeas
  ? "New plugin idea via yoursite.com"
  : "New contact request via yoursite.com";
---

<BaseLayout title="Contact" description="Contact form for artist requests.">
  <section class="contact-page">
    <header class="contact-head">
      <h1>{isPluginIdeas ? "Submit your plugin idea" : "Contact"}</h1>
      <p class="small">
        {
          isPluginIdeas
            ? "Share your idea, workflow, or pain point and I will review it."
            : "Contact me for mixing, mastering, plugin, or collaboration requests."
        }
      </p>
    </header>

    {
      !isConfigured && (
        <p class="card setup-hint">
          Form not active yet: add `PUBLIC_WEB3FORMS_ACCESS_KEY` to your `.env`
          so messages can be sent.
        </p>
      )
    }

    <form
      id="contact-form"
      class="card contact-form"
      action="https://api.web3forms.com/submit"
      method="POST"
    >
      <input type="hidden" name="access_key" value={web3formsAccessKey} />
      <input type="hidden" name="subject" value={formSubject} />
      <input type="hidden" name="from_name" value="Artist Page Contact Form" />

      <input
        type="checkbox"
        name="botcheck"
        class="botcheck"
        tabindex="-1"
        autocomplete="off"
      />

      <label for="name">Name</label>
      <input id="name" name="name" type="text" required />

      <label for="email">Email</label>
      <input id="email" name="email" type="email" required />

      <label for="message"
        >{isPluginIdeas ? "Your plugin idea" : "Message"}</label
      >
      <textarea
        id="message"
        name="message"
        rows="7"
        required
        placeholder={isPluginIdeas
          ? "Example: I need a plugin for ... My current workflow is ... The problem is ..."
          : undefined}></textarea>

      <label class="consent">
        <input type="checkbox" name="consent" required />
        <span>
          I agree to the processing of my data for contact purposes according to
          the <a href="/datenschutz">Privacy Policy</a>.
        </span>
      </label>

      <div class="actions">
        <button class="btn primary" type="submit" disabled={!isConfigured}>
          Send message
        </button>
        <p id="form-status" class="status-box" hidden aria-live="polite"></p>
        <p class="small">
          Or email me directly:
          <a href="mailto:your@email.com">your@email.com</a>
        </p>
      </div>
    </form>
  </section>

  <style>
    .contact-page {
      width: min(100%, 860px);
      margin: 0 auto;
      display: grid;
      gap: 18px;
      padding: 12px 0 24px;
    }
    .contact-head h1 {
      margin: 0;
      font-size: clamp(34px, 5vw, 52px);
      line-height: 1.06;
    }
    .contact-head p {
      margin: 10px 0 0;
      max-width: 68ch;
    }
    .setup-hint {
      margin: 0;
      border-style: dashed;
      opacity: 0.92;
    }
    .contact-form {
      display: grid;
      gap: 10px;
      padding: clamp(16px, 2.2vw, 24px);
    }
    .contact-form label {
      font-size: 14px;
      opacity: 0.9;
    }
    .contact-form input,
    .contact-form textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.07);
      color: inherit;
      padding: 11px 12px;
      font: inherit;
    }
    .contact-form textarea {
      resize: vertical;
      min-height: 160px;
    }
    .contact-form input:focus,
    .contact-form textarea:focus {
      outline: 2px solid rgba(118, 175, 255, 0.5);
      outline-offset: 1px;
    }
    .consent {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      margin-top: 4px;
    }
    .consent input {
      width: 16px;
      height: 16px;
      margin-top: 3px;
      padding: 0;
      flex: 0 0 auto;
    }
    .actions {
      display: grid;
      gap: 8px;
      margin-top: 6px;
    }
    .actions p {
      margin: 0;
    }
    .status-box {
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid transparent;
    }
    .status-box.success {
      border-color: rgba(89, 214, 121, 0.45);
      background: rgba(89, 214, 121, 0.16);
      color: rgba(214, 255, 224, 0.95);
    }
    .status-box.error {
      border-color: rgba(255, 117, 117, 0.45);
      background: rgba(255, 117, 117, 0.16);
      color: rgba(255, 224, 224, 0.95);
    }
    .botcheck {
      position: absolute;
      left: -9999px;
      opacity: 0;
      pointer-events: none;
    }
  </style>

  <script is:inline>
    (() => {
      const form = document.getElementById("contact-form");
      const status = document.getElementById("form-status");

      if (
        !(form instanceof HTMLFormElement) ||
        !(status instanceof HTMLElement)
      )
        return;

      const submitButton = form.querySelector("button[type='submit']");

      const showStatus = (message, type) => {
        status.textContent = message;
        status.classList.remove("success", "error");
        status.classList.add(type);
        status.hidden = false;
      };

      form.addEventListener("submit", async (event) => {
        event.preventDefault();

        if (
          submitButton instanceof HTMLButtonElement &&
          submitButton.disabled
        ) {
          return;
        }

        if (submitButton instanceof HTMLButtonElement) {
          submitButton.disabled = true;
        }

        showStatus("Sending message...", "success");

        try {
          const formData = new FormData(form);
          const payload = Object.fromEntries(formData.entries());

          const response = await fetch("https://api.web3forms.com/submit", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify(payload),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            showStatus(
              "Thanks, your message was sent successfully.",
              "success",
            );
            form.reset();
          } else {
            showStatus(
              result.message ||
                "Message could not be sent. Please try again in a moment.",
              "error",
            );
          }
        } catch (_error) {
          showStatus(
            "Network error. Please check your connection and try again.",
            "error",
          );
        } finally {
          if (submitButton instanceof HTMLButtonElement) {
            submitButton.disabled = false;
          }
        }
      });
    })();
  </script>
</BaseLayout>
